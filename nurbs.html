<!DOCTYPE html>
<html>
<body>
<canvas id="canvas" width="800" height="600">No &lt;canvas&gt; support</canvas>
<script>"use strict";
var cpoints = [
	[200,0],
	[200,500],
	[700,500]];
var knots = [0,1,2];

function linear(startx, starty, endx, endy) {
	startx = parseFloat(startx);
	starty = parseFloat(starty);
	endx = parseFloat(endx);
	endy = parseFloat(endy);
	
	if (isNaN(startx) || isNaN(starty) || isNaN(endx) || isNaN(endy) || startx >= endx)
		return function(){return 0;};
	var slope = (endy - starty) / (endx - startx);
	var y0 = starty-slope*startx;
	return function(x){return x*slope + y0;};
}

function interpolate(funcs, points, pos) {
	pos = parseFloat(pos);
	var len = funcs.length|0;
	if (len !== points.length|0)
		throw "number of basis functions and points differ";
	if (!len)
		throw "no points to interpolate";
	var numComponents = points[0].length|0;
	var res = new Array(numComponents);
	for (var comp = 0; comp < numComponents; comp = comp+1|0)
		res[comp] = 0;
	for (var i = 0; i < len; i = i+1|0) {
		var point = points[i];
		var weight = funcs[i](pos);
		if ((point.length|0) !== numComponents)
			throw "number of components in points differ";
		for (comp = 0; comp < numComponents; comp = comp+1|0) {
			res[comp] += point[comp]*weight;
		}
	}
	return res;
}

function constantOne(){return 1}

function basisFunction(knots) {
	if (knots.length === 0)
		return constantOne;
	var end = (knots.length|0)-1|0;
	var left = basisFunction(knots.slice(0, end));
	var right = basisFunction(knots.slice(1));
	var start = knots[1], stop = knots[end];
	var w1 = linear(knots[0],0, knots[end-1|0],1);
	var w2 = linear(start,1, stop,0);
	return function(x) {
		if (x < start) return left(x)*w1(x);
		if (x > end) return right(x)*w2(x);
		return left(x)*w1(x) + right(x)*w2(x);
	};
}

function plotFunc(ctx, func, start, end) {
	var step = (end-start)/100;
	ctx.beginPath();
	ctx.moveTo(0, 600-func(start)*600);
	for (var i = 1; i < 10; i = i+1|0) {
		var v = func(start+step*i);
		ctx.lineTo(80*i, 600-v*600);
		console.log(v);
	}
	ctx.lineTo(800, 600-func(end)*600);
	ctx.stroke();
}

function drawNurbs(ctx, cpoints, knots) {
	var numKnots = knots.length|0;
	knots = knots.slice();
	knots.unshift(knots[0]);
	knots.push(knots[numKnots]);
	var numPoints = cpoints.length|0;
	var targetDegree = Math.floor((numKnots-numPoints|0)/2);
	var basisFunctions = new Array(numPoints);
	for (var i = 0; i < numPoints; i = i+1|0) {
		var func = basisFunction(knots.slice(i, i+((targetDegree+1)<<1)|0));
		plotFunc(ctx, func, knots[1], knots[numKnots]);
		basisFunctions[i] = func;
	}

	ctx.beginPath();
	var point = interpolate(basisFunctions.slice(0, targetDegree+2|0),
		cpoints.slice(0,targetDegree+2|0), knots[0]);
	ctx.moveTo(point[0], point[1]);
	for (var section = 1|0; section < numKnots; section = section+1|0) {
		var slice = function(a) {return a.slice(section-1, (section+targetDegree|0)+1|0);}
		point = interpolate(slice(basisFunctions), slice(cpoints), knots[section]);
		ctx.lineTo(point[0], point[1]);
	}
	ctx.stroke();
}

drawNurbs(document.getElementById('canvas').getContext('2d'), cpoints, knots);
</script>
</body>
</html>